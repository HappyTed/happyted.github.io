<!DOCTYPE html>
<html lang="ru">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>PUSH-уведомления</title>
        <link rel="stylesheet" href="styles.css">

        <!-- PUSH SDK -->

        <script src="https://www.gstatic.com/firebasejs/5.2.0/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/5.2.0/firebase-messaging.js"></script>

        <script type="text/javascript" src="ak-push.js"></script>
        <link rel="manifest" href="manifest.json">

        <!-- Кастомный скрипты с разными кастомными методами -->
        <script src="script.js"></script>
        <script>
            function myFunction(data){
                // запись в сервис
                options = {
                    method: 'POST', 
                    headers: {
                        'Content-Type': 'application/json',
                        'Access-Control-Allow-Origin': '*'
                    },
                    body: data
                };

                // URL сервиса
                const url = 'http://push-test-lab.qa.altcraft.com:8080/v1/messages/save';

                console.log("Try sending push message in service...")
                // Отправка запроса
                fetch(url, options)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok ' + response.statusText);
                        }
                        return response.json(); // Разбираем JSON-ответ
                    })
                    .then(data => {
                        console.log('Success:', data); // Обработка данных ответа
                    })
                    .catch(error => {
                        console.error('Error:', error); // Обработка ошибок
                    });
            
            
                // Предотвращение преждевременного завершения service worker. Правильная остановка и показ пуша
                
                event.waitUntil(    
                    self.registration.showNotification(title, options)
                );
            }
        </script>
    </head>

    <body>
        
        <div class="container">
            <h1>Добро пожаловать!</h1>
            <p>Пожалуйста, представьтесь:</p>
            <input type="text" id="nameInput" placeholder="Ваше имя"><br>
            <input type="text" id="lnameInput" placeholder="Ваша Фамилия"><br>
            <input type="text" id="emailInput" placeholder="Ваш email"><br>
            <!-- Кнопка подписки -->
            <button type="button" id="init_sub">PUSH - подписка</button>
            <button type="button" id="send" onclick="myFunction(data)">Send push</button>
        </div>


        <div class="pushProcessing">
            <script>
                document.getElementById('init_sub').addEventListener('click', () => {
                    window.subscribe();
                });

                data = {}
                
                self.addEventListener('push', function(event) {
                    data = window.handlePushEvent(event);
                });
            </script>

            <input type="text" id="dataPush" readonly>

            <script>
                document.getElementById('dataPush').value = data
            </script>
        </div>

    </body>

</html>


